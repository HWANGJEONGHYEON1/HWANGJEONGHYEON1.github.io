---
layout: post
title:  "대규모시스텀 설계 기초"
date:   2023-08-23 23:20:21 +0900
categories: book
---

> 가상 면접 사례로 배우는 대규모 시스템 설계 기초

## 데이터 베이스 처리
> 웹/모바일 트래픽 처리 서버와 디비서버를 분리하면 각각 독립적으로 확장 가능

### 어떤 디비 선택?
1. RDBMS
2. NoSQL
    - 낮은 응답 지연시간이 요구됨
    - 다루는 데이터가 비정형이라 관계형이 아님
    - 데이터를 직렬화 역직렬화 할 수 있기만 하면 됨
    - 아주 많은 양의 데이터를 저장할 필요가 있음


### 수직 vs 수평
로드벨런서
- 사용자는 로드밸러서의 공개IP주소로 접속한다. => 웹 서버는 클라이언트의 접속을 직접 처리 X
- 서버를 추가함으로써 로드밸러서가 부하분산을 진행하여 서버 수를 증가시켜도 OK

`디비라면?`
다중화: master-slave 구조로 원본은 마스터 사본은 슬레이브에 저장한다.
변경 연산은 마스터에서 처리되지만, 읽기 연산은 서버들로 분산처리하여 실행된다.
가용성 up -> 데이터들을 여러 지역에 복제하므로써 장애 발생 시 다른 서버에서 가져올 수 있다.

디비에 부하를 줄일려면 ? `캐시`

<hr>

## 캐시
> 캐시는 값비싼 연산 결과나 자주 참조되는 데이터를 메모리안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소.

캐시계층
- 잠시 보관되는 곳으로 데이터 베이스보다 빠르다.
- 디비의 부하를 줄일 수 있다.
- 웹서버 -> 캐시 -> 디비 

유의사항 
1. 데이터 갱신은 자주 일어나지 않지만, 참조는 빈번하게 일어날 때 고려해보자
2. 캐시는 데이터를 휘발성 메모리에 두기때문에, 영속적으로 저장하는 것은 바람직하지 않다.
3. 만료는 어떻게 되는가, 너무 길면 원본과 차이가 있을 수 있고, 짧으면 디비를 자주 조회할 것이다.
4. 저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랜잭션이 아니라면 일관성이 깨질 수 있다.
5. 장애시? 캐시 서버를 한 대만 둔다면 장애가 발생할 수 있다. 캐시를 여러 분산으로 처리해야한다.
6. 데이터 방출 정책? 캐시가 꽉 차면 추가로 캐시에 데이터를 넣어야할 경우 기존 데이터를 내보내야한다. LRU

`CDN`
> CDN은 정적 컨텐츠를 전송하는데 쓰이지만, 지리적으로 분산된 서버의 네트워크이다.

동작과정
1. 사용자가 웹사이트 방문
2. 사용자에가 가장 가까운 CDN 서버가 정적 콘텐츠로 전달
3. CDN서버에 이미지가 없으면 원본서버에서 가져옴 (오래걸림)
4. CDN 전달

고려사항 
- 비용: 사업자에 의해 운영되기 때문에 데이터 전송량에 따라 요금이 듬, 자주 사용되지 않는 것들은 빼는 것을 고려
- 적절한 만료시간 설정: 길면 컨텐츠의 신선도가 떨어지고, 짧으면 원본서버에 빈번히 접속해야함
- 장애 대응: CDN이 죽었을 경우 웹은 어떻게 처리해야할지 
    - 컨텐츠 서비스 무효화

<hr>

현재까지 구조

정적 컨텐츠는 웹서버에서 서비스하지 않고 CDN을 통해 제공, 캐시가 디비의 부하를 줄여준다.

![구조](https://github.com/HWANGJEONGHYEON1/HWANGJEONGHYEON1.github.io/assets/43225288/150b8c8d-27fc-4190-a0fe-ea5487af0962)

<hr>

## 시스템 설계
요구사항 파악
- 구체적 어떤 기능을 만들어야할까
- 제품의 사용자수는?
- 주라 사용하는 기술 스택은?

### 예제
> 뉴스 피드 시스템을 설계

모웹과 웹앱 중 어느것을 지원해야하나? 둘 다?
<b>둘다</b>
가장 중요한 기능은?
<b>새로운 포스터를 올리고 다른 친구의 뉴스피드를 볼 수 있어야한다</b>
시간 역순으로 정렬되어야하나? 정렬기준이 있나? 친구의 포스트가 가장 가깝게 보여야하나?
<b>시간 역순으로</b>
사용자는 팔로우 수가 최대 몇명인가? 트래픽 수는 어느정도인가?
<b>5000 일간 천만명</b>
이미지나 비디오 같은 것도 올려야하나
<b>지원해야함</b>

개략적인 플로우
1. 피드 발행
    - 사용자가 포스트를 올리면 데이터가 캐시 및 디비에 저장되고 사용자 친구에게 보여진다.

2. 피드 생성(조회)
    - 어떤 사용자의 뉴스피드는 해당 사용자의 친구들의 포스트를 시간 역순으로 정렬 

![구조](https://github.com/HWANGJEONGHYEON1/HWANGJEONGHYEON1.github.io/assets/43225288/94f97cb6-d8d1-40e5-8021-4b0e1f6ce5c3)


발행에 대한 상세 설계
![상세](https://github.com/HWANGJEONGHYEON1/HWANGJEONGHYEON1.github.io/assets/43225288/32e8c417-f0a3-47a9-82e6-6f5cb451a583)

### 처리율 제한 설계
> API 요청 횟수가 제한 장치에 정의된 임계치를 넘어서면 추가로 도달한 모든 호출은 처리가 중단된다.

예)
어떤 종류의 처리율 제한장치인가? 클라이언트? 서버?
`서버측 API를 위한 장치`
어떤 기준으로 API 제어해야하나 ? 사용자 ID, IP?
`다양한 형태의 제어규칙을 통해 유연한 시스템`
시스템 규모는?
`대규모`
분산환경에서 작동해야하나?
`yes`
사용자에게 제한된 사실을 명시해야하나?
`yes`

요구사항 요약
- 설정된 처리율을 넘어서면 제한
- 낮은 응답시간을 줘야함
- 분산형 처리율 제한
- 예외처리: 요청이 제한되었을 때 사용자에게 적시
- 제한장치가 장애가나도 서비스에 영향을 주면 안됨


