---
layout: post
title:  "요청매핑"
date:   2021-05-17 15:45
categories: spring, log
tags: [spring, slf4j]
---

### 요청 매핑


#### PathVariable
    - 최근 HTTP API는 리소스 경로에 식별자를 넣는 스타일을 선호
        - `/mapping/useA`
        - `/mapping/1`

```java
    @GetMapping("/mapping/{userId}")
    public String mappingPath(@PathVariable String userId){
        log.info("mappingPath {}", userId);
        return "ok";
    }

    @GetMapping("/mapping/users/{userId}/orders/{orderId}")
    public String mappingPath(@PathVariable String userId, @PathVariable Long
            orderId) {
        log.info("mappingPath userId={}, orderId={}", userId, orderId);
        return "ok";
    }
```

#### 미디어 타입 조건 매핑 - HTTP 요청 Content-type, consume

    - consume
        - Content-Type 헤더 기반 추가 매핑 Media Type
        - MediaType.APPLICATION_JSON_VALUE
    - produces
        - Accept 헤더 기반 Media Type
~~~
consumes = "text/plain"
consumes = {"text/plain", "application/*"} 
consumes = MediaType.TEXT_PLAIN_VALUE
~~~
    

```java
    @PostMapping(value = "/mapping-consume", consumes = "application/json") public String mappingConsumes() {
        log.info("mappingConsumes");
        return "ok";
    }

    @PostMapping(value = "/mapping-produce", produces = "text/html") public String mappingProduces() {
        log.info("mappingProduces");
        return "ok";
    }

```

#### API 예시
    - URL 매핑
        - 회원목록조회 GET /users
        - 회원등록 POST /users
        - 회원 조회 GET /users/{userId}
        - 회원 수정 PUT /users/{userId}
        - 회원 삭제 DELETE /users/{userId}

```java
    @GetMapping("/mapping/users")
    public String user() {
        return "get users";
    }

    @PostMapping("/mapping/users")
    public String addUser() {
        return "post user";
    }

    @GetMapping("/mapping/users/{userId}")
    public String findUser(@PathVariable String userId) {
        return "get userid = " + userId;
     }

    @PatchMapping("/mapping/users/{userId}")
    public String mod(@PathVariable String userId) {
        return "update userId=" + userId;
     }

    @DeleteMapping("/mapping/users/{userId}")
    public String delete(@PathVariable String userId) {
        return "delete userId= " + userId;
     }
```


#### 요청 헤더 정보 가져오기
    - HttpServletRequest
    - HttpServletResponse
    - HttpMethod
    - Locale : Locale 정보
    - @RequestHeader MultiValueMap<String, String> headerMap
        - 모든 HTTP 헤더를 MultiValueMap 형식으로 조회
    - @RequestHeader("host") String host
        - 특정 HTTP 헤더를 조회
        - 속성
            - 필수 값 여부 : required
            - 기본 값 속성 : defaultValue
    - @CookieValue(value = "myCookie", required=false) String cookie
        - 특정 쿠키를 조회
    - `MultiValueMap` 
        - 하나의 키에 여러 값을 받을 수 있음
        - HTTP header, HTTP 쿼리 파라미터와 같이 하나의 키에 여러 값을 받을 때 사용 => keyA=value1&keyA=value23


```java
    @RequestMapping("/headers")
    public String headers(HttpServletRequest request,
                          HttpServletResponse response,
                          HttpMethod httpMethod,
                          Locale locale,
                          @RequestHeader MultiValueMap<String, String> headerMap,
                          @RequestHeader("host") String host,
                          @CookieValue(value = "myCookie", required = false) String cookie) {

        log.info("request={}", request);
        log.info("response={}", response);
        log.info("httpMethod={}", httpMethod);
        log.info("locale={}", locale);
        log.info("headerMap={}", headerMap);
        log.info("header host={}", host);
        log.info("myCookie={}", cookie);

        return "ok";
    }
```

#### HTTP 요청 파라미터 - @RequestParam, @ModelAttribute

* @RequestParam
    - @RequestParam("username") String memberName == request.getParameter("username")

* @ModelAttribute

```java
@RequestParam String username;
@RequestParam int age;

HelloData data = new HelloData(); 
data.setUsername(username); 
data.setAge(age);
```

* 예시 코드
```java
@Slf4j
@Controller
public class RequestParamController {

    @RequestMapping("/request-param-v1")
    public void requestParamV1(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
        String username = request.getParameter("username");
        int age = Integer.parseInt(request.getParameter("age"));

        log.info("username = {}, age = {}" , username, age);
        response.getWriter().write("ok");
    }

    @ResponseBody
    @RequestMapping("request-param-v2")
    public String requestParamV2(@RequestParam("username") String memberName,
                               @RequestParam("age") int memberAge) {

        log.info("username={}, age={}", memberName, memberAge);
        return "ok";
    }

    @ResponseBody
    @RequestMapping("request-param-v3")
    public String requestParamV3(@RequestParam String username,
                                 @RequestParam int age) {

        log.info("username={}, age={}", username, age);
        return "ok";
    }

    @ResponseBody
    @RequestMapping("request-param-v4")
    public String requestParamV4(String username,
                                 int age) {

        log.info("username={}, age={}", username, age);
        return "ok";
    }

    @ResponseBody
    @RequestMapping("request-param-required")
    public String requestParamV5(@RequestParam String username,
                                 @RequestParam(required = false) Integer age) {

        log.info("username={}, age={}", username, age);
        return "ok";
    }

    @ResponseBody
    @RequestMapping("request-param-default")
    public String requestParamDefault(@RequestParam(defaultValue = "guest") String username,
                                 @RequestParam(required = false, defaultValue = "-2") Integer age) {

        log.info("username={}, age={}", username, age);
        return "ok";
    }

    @ResponseBody
    @RequestMapping("request-param-map")
    public String requestParamMap(@RequestParam Map<String, String> paramMap) {

        log.info("username={}, age={}", paramMap.get("username"), paramMap.get("age"));
        return "ok";
    }

    @ResponseBody
    @RequestMapping("/model-attribute-v1")
    public String modelAttributeV1(@ModelAttribute HelloData helloData) {
        log.info("username={}, age={}", helloData.getUsername(), helloData.getAge());

        return "ok";
    }

    @ResponseBody
    @RequestMapping("/model-attribute-v2")
    public String modelAttributeV2(HelloData helloData) {
        log.info("username={}, age={}", helloData.getUsername(), helloData.getAge());

        return "ok";
    }
}
```

#### HTTP 요청 메시지 - 단순 텍스트

* HTTP message body
    - HTTP APi에서 주로 사용, json,xml,text
    - 데이터형식은 주로 json
    - POST,PUT,PATCH
    - 요청 파라미터와는 다르게 HTTP 메시지 바디를 통해 데이터가 직접 오는경우 에는 @RequestParam, @ModelAttribute를 사용할 수 없다.

* HTTP 바디 내용은 `request.getInputStream();` 로 읽을 수 있다.
* Input, Output 스트림, Reader 도 지원한다.
* HttpEntity<String> httpEntity 지원한다.
    - HttpEntity
        - 메시지 바디 정보를 직접 조회
        - 요청 파라미터와는 상관없음
        - 메시지 바디 정보 직접 반환 응답사용가능
        - 헤더 정보 포함
        - view 조회는 할 수 없다.
        - RequestEntity
            - 요청에서 사용가능
        - ResponseEntity
            - HTTP 상태 코드 설정 가능, 응답에서 사용
            - ` return new ResponseEntity<String>("Hello World", responseHeaders,HttpStatus.CREATED`
* 예시코드

```java

@Slf4j
@Controller
public class RequestBodyStringController {

    @PostMapping("/request-body-string-v1")
    public void requestBodyString(HttpServletRequest request, HttpServletResponse response) throws IOException {

        final ServletInputStream inputStream = request.getInputStream();
        final String messageBody = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);

        log.info("messageBody= {}", messageBody);
        response.getWriter().write("ok");
    }

    @PostMapping("/request-body-string-v2")
    public void requestBodyStringV2(InputStream inputStream, Writer writer) throws IOException {

        final String messageBody = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);

        log.info("messageBody= {}", messageBody);
        writer.write("ok");
    }

    @PostMapping("/request-body-string-v3")
    public HttpEntity<String> requestBodyStringV3(HttpEntity<String> httpEntity) throws IOException {

        final String body = httpEntity.getBody();
        log.info("messageBody= {}", body);

        return new HttpEntity<>("ok");
    }

    @ResponseBody
    @PostMapping("/request-body-string-v4")
    public String requestBodyStringV4(@RequestBody String messageBody) throws IOException {

        final String body = messageBody;
        log.info("messageBody= {}", body);

        return "ok";
    }
}
```

#### HTTP 요청 메시지 - JSON

* HttpServletRequest를 사용해서 직접 HTTP 메시지 바디에서 데이터를 읽어와 문자로 변환
* 문자로 된 JSON 데이터를 Jackson 라이브러리인 ObjectMapper를 사용하여 자바 객체로 변환

* RequestBody
    - HttpMessageConverter -> StringHttpMessageConverter
    - 생략 불가능
        - 스프링은 생략 시 @ModelAttribute, @RequestParam을 대입한다. 
            - String, int, Integer 단순타입 => @RequestParam
            - 나머지 => @ModelAttribute
    
* ResponseBody
    - 사용 시에 객체르 그대로 반환할 경우
        - 클라이언트 헤더 정보 중 accept를 application/json 으로 변경해야 받을 수 있다.

* 예시코드

```java

@Slf4j
@Controller
public class RequestBodyJsonController {

    private ObjectMapper mapper = new ObjectMapper();

    @PostMapping("/request-body-json-v1")
    public void requestBodyJsonV1(HttpServletRequest request, HttpServletResponse response) throws IOException {
        final ServletInputStream inputStream = request.getInputStream();
        String messageBody = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);
        log.info("messageBody= {}", messageBody);
        HelloData helloData = mapper.readValue(messageBody, HelloData.class);
        log.info("helloData= {}", helloData);

        response.getWriter().write("ok");
    }

    @ResponseBody
    @PostMapping("/request-body-json-v2")
    public String requestBodyJsonV2(@RequestBody String messageBody) throws IOException {
        log.info("messageBody= {}", messageBody);
        HelloData helloData = mapper.readValue(messageBody, HelloData.class);
        log.info("helloData= {}", helloData);

        return "ok";
    }

    @ResponseBody
    @PostMapping("/request-body-json-v3")
    public String requestBodyJsonV3(@RequestBody HelloData helloData) throws IOException {
        log.info("helloData= {}", helloData);
        return "ok";
    }

    @ResponseBody
    @PostMapping("/request-body-json-v4")
    public String requestBodyJsonV4(HttpEntity<HelloData> helloData) throws IOException {
        log.info("helloData= {}", helloData.getBody());
        return "ok";
    }

    @ResponseBody
    @PostMapping("/request-body-json-v5")
    public HelloData requestBodyJsonV5(@RequestBody HelloData helloData) {
        log.info("helloData= {}", helloData);
        return helloData;
    }
}

```

    


### Ref.
* <https://https://www.inflearn.com/>

