---
layout: post
title:  "JPA 정리 - 연관관계 매핑"
date:   2021-06-26 11:30
categories: book, jpa
tags: [book, jpa]
---

## 연관관계 매핑

### 연관관계가 필요한 이유
    - 객체를 테이블에 맞추어 모델링을 하면, 협력 관계를 만들 수 없다.
        - `테이블은 외래키로 조인`을 사용해서 연관된 테이블을 찾는다.
        - `객체는 참조를 사용`해서 연관된 객체를 찾는다.
        - 테이블과 객체 사이에는 격차 존재.

### 객체의 양방향 관계
    - 객체의 양방향 관계는 양방향 관계가 아니라 서로 다른 단방향 관계이다.
    - 객체를 양방향으로 참조하려면 단방향 연관관계를 2개를 만들어야한다.
    - 테이블은 외래키 하나로 양방향 관계가 성립한다.

### 연관관계 주인
    - 객체의 두 관계 중 하나를 연관관계 주인으로 지정
    - 연관관계 주인만이 외래 키를 관리(등록, 수정)
    - 주인이 아닌 쪽은 readable
    - 주인은 mappedBy 속성 사용하면 안된다.
    - 주인이 아니면 mappedBy 속성으로 주인 지정
    - 외래키가 있는 곳을 주인으로
        - ManyToOne (다대일) 다 쪽이 연관관계 주인

### 양방향 연관관계
    - 순수 객체 상태를 고려하여 양쪽에 값을 세팅
        - 1차 캐시를 통해 데이터를 가져왔을 경우, 메모리에는 각 객체의 관계를 모르기 때문에 외래키로 참조한 값을 가져올 수 없다. -> flush(), clear()를 통해서 재 조회하면 할 수 있다.
    - 양방향 매핑 시에 편의 메소드를 생성
        - ex) setTeam의 경우 멤버만 저장하는 것이 아니라 아래 코드와 같이 작성한다.
```java

public void setTeam(Team team) {
    this.team = team;
    team.getMembers().add(this); //this는 현재 member
}

```
    - 양방향 매핑 시 무한루프 조심
        - toString(), lombok, JSON 생성 라이브러리
            - Member 클래스에 team이라는 객체가 있고 toString()이 있는대, Team이라는 클래스에 members라는 List가 있으면서 toString이 있는대, 서로 toString 부르는 일이 발생하여 StackOverflow 발생


### 양방향 매핑
    - 단방향 매핑만으로 이미 연관관계 매핑이 완료된다.
    - 양방향 매핑은 반대 방향으로 조회기능이 추가(그래프 탐색)
    - JPQL에서 역방향으로 탐색할 일이 많음
    - 필요할 때 양방향 추가하면 됨.