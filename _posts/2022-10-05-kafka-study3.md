---
layout: post
title:  "[study] kafka - 3"
date:   2022-10-05 16:20:21 +0900
categories: kafka
---

> 카프카 스터디 3

## 프로듀서
- 카프카에서 데이터의 시작점
- 카프카에 필요한 데이터를 선언하고 브러코의 특정 토픽의 파티션에 전송
- 프로듀서는 데이터를 전송할 때 리더 파티션을 가직고 있는 카프카 브로커와 직접 통신
- 리더가 아닌 파티션은 리더파티션을 복제하는 역할
- 카프카 브로커로 데이터를 전송할 때 내부적으로 파티셔너, 배치 생성 단계를 거친다.

### 내부구조
- ProducerRecord: 프로듀서에서 생성하는 레코드, 오프셋은 미포함
	- 오프셋은 카프카 클러스터로 전송된 후 생성된다.
- send() 레코드를 전송하는 요청 메서드
- Partioner: 어느 파티션으로 전송할지 지정하는 파티셔너, 기본값으로 DefaultPationer로 설정
- Accumulator: 배치로 묶어 전송할 데이터를 모으는 버퍼
- 레코드를 선언하고 send()를 호출하여 파티셔너,acuumalator를 거쳐 데이터를 보낸다.

### 파티셔너
- 프로듀서 API를 활용하면, UniformStickyPartioner, RoundRobinPartioner 2개 파티셔너를 제공한다.
- 메시지키가 있을경우 동작
	- UniformStickyPartioner와 RoundRobinPartioner 둘다 메시지 키가 있을때는 메시지 키의 해시값과 파티션을 매칭하여 레코드를 전송
	- 동일한 메시지 키가 존재하는 레코드는 동일한 파티션 번호를 전달됨
	- 만약 파티션 개수가 변경될 경우 메시지 키와 파티션 `번호 매칭은 깨지게 됨`
		- => 파티션 개수를 충분히 늘리자.
- 메시지가 없을 때
	- 파티션에 최대한 동일하게 분배하는 로직이 있는대 UniformStickyPartioner는 RoundRobinPartioner를 단점을 개선
- RoundRobinPartioner
	- 들어오는대로 파티션을 순회
	- 어큐뮤레이터에서 묶인느 정도가 적기 때문에 전송 성능이 낮음
- UniformStickyPartioner
	- 배치로 묶일뿐 결국 파티션 순회하면서 보내기 때문에 모든 파티션에 분배되어 전송됨

#### 프로듀서의 커스넘 파티셔너
	- 자바에서는 파티셔너 인터페이스를 제공
	- 메시지키 또는 메시지 값에 따라 파티션 지정 로직을 적용할 수 있다.
	- 메시지 키, 값에 따른 파티션 지정로직을 적용 가능
	- 파티셔너를 통해 파티션이 지정된 데이터는 어큐뮬레이터에 버퍼로 쌓인다.
	- 센더 스레드는 어뮤큘레이터에 쌓인 배치 데이터를 가져가 카프카 브로커로 전송

## reference
- https://www.inflearn.com/course/%EC%95%84%ED%8C%8C%EC%B9%98-%EC%B9%B4%ED%94%84%EC%B9%B4-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D