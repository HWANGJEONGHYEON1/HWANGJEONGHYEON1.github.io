---
layout: post
title:  "아파치 카프카 스터디 - 7"
date:   2023-01-26 23:20:21 +0900
categories: kafka, spring
---

> 아프치 카프카 애플리케이션 프로그래밍 스터디 - 7


# 목표?
- 회사에서 대용량 데이터를 처리하는것에 있어, 카프카를 사용하고 있으므로, 제대로된 학습을 통해 원하는 처리를 할 수 있도록 한다.

# 상세개념

###  카프카 컨슈머

* > 멀티스레드 컨슈머
    - 카프카는 처리량을 늘리기 위해 파티션과 컨슈머 개수를 늘릴 수 있다.
    - 파티션을 여러개로 운영하는 경우 데이터를 병렬처리 하기 위해서 파티션 개수와 컨슈머 개수를 동일하게 하는것이 좋다.
    - 멀티스레드 컨슈머를 안전하게 운영하기 위해 고려사항
        - 하나의 프로세스 내부에 스레드가 여러 개 생성되어 실행되기 때문에 하나의 컨슈머 스레드에서 예외적 상황이 발생할 경우 프로세스 자체가 종료될 수 있고 다른 컨슈머 스레드에 영향을 미칠 수 있다.
        - 컨슈머 스레드들이 비정상적으로 종료될 경우 데이터 처리에서 중복 또는 유실이 발생할 수 있다.
        - 각 컨슈머 스레드들 간에 영향이 미치지 않도록 스레드 세이프 로직, 변수를 적용해야한다.
    - 컨슈머 스레드는 1개만 실행하고 데이터 처리를 담당하는 워커 스레드를 여러 개 실행하는 방법
    - 컨슈머 인스턴스에서 poll() 메서드를 호출하는 스레드를 여러 개 띄워서 사용하는 컨슈머 멀티 스레드 전략

<br />
<br />
<br />

* > 컨슈머 렉
    - 컨슈머 그룹과 토픽, 파티션 별로 생성된다. 1개의 토픽에 3개의 파티션이 있고 1개의 컨슈머 그룹이 토픽을 구독하여 데이터를 가져가면 커슈머 랙은 3개가된다.
    - 프로듀서가 보내는 데이터양이 컨슈머의 데이터 처리량보다 크다면 컨슈머 렉은 늘어난다.
    - 컨슈머 렉을 모니터링하는 것은 카프카를 통한 데이터 파이프라인을 운영하는 데에 핵심적인 역할을 한다.
        - 모니터링함으로써 컨슈머의 장애를 확인할 수 있고, 파티션 개수를 정하는 데에 참고할 수 있다.
        - ex) 2개의 파티션으로 구성된 2개의 컨슈머가 각각 할당되어 데이터를 처리한다고 가정해보자.
            - 프로듀서가 보내는 데이터량은 동일한대 파티션 1번의 컨슈머 랙이 늘어나는 상황이 발상한다면 1번 파티션에 할당된 컨슈머에 이슈가 발생했다고 유추할 수 있다.
    - 랙을 확인하는 방법   
        1. 카프카 명령어
            > bin/kafka-consumer-groups.sh --bootstrap-server my-kafka:9092 \ --group my-group --describe
        2. 컨슈머 어플리케이션의 metrics()
            ```java
            for (Map.Entry<MetricName, ? extends Metric> entry : kafkaConsumer.metrics().entrySet()) {
                if ("record-lag-max".equals(entry.getKey().name()) |
                "records-lag".equals(entry.getKey().name() |
                "records-lag-avg".equals(entry.getKey().name()))) {
                    Metric metric = entry.getValue();
                }
            } 
            ```
            - 컨슈머가 정상 동작할 경우만 확인
            - 모든 컨슈머 애플리케이션에 모니터링 코드를 중복해서 작성해야한다.
        3. 외부 모티러링 툴
            - 가장 최선의 방법
            - 데이터독, 컨플루언트 컨트롤 센터 같은 종합 모니터링
            - 모니터링 지표에는 컨슈머 랙도 포함
            - 오픈소스는 버로우

    - 컨슈머가 어떠한 이유로 데이터를 더는 가져가지 않을 때, 버로우는 파티션은 STAILED, 컨슈머는 ERROR 상태로 나타낸다. 이로써 즉각 조치를 취해야한다.

    - 컨슈머 랙 모니터링 아키텍처
        - 별개의 저장소와 대시보드를 이용하는 것이 좋다.
        - 준비물
            - 버로우 : REST API를 통해 컨슈머 랙을 조회할 수 있다.
            - 텔레그래프 : 데이터 수집 및 전달에 특화된 툴, 버로우를 조회하여 데이터를 엘라스틱 서치에 전달한다.
            - 엘라스틱 서치: 컨슈머 랙 정보를 담는 저장소
            - 그라파나: 엘라스틱서치의 정보를 시각화하고 특정 조건에 따라 슬랙 알람을 보낼 수 있는 웹 대시보드 툴

<br />
<br />
<br />
